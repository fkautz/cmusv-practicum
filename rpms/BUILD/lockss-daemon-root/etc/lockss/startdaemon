#!/bin/bash
# Script run as root from /etc/init.d/lockss to start the daemon
# as the specific user provided as the argument. Although this
# script is common to Linux and Solaris it runs under bash on both.
# After any change to this file it must be tested on both Linux
# and Solaris.

is_secure() {
    RET=1
    RES=`find ${1} -user root -a ! -perm /022`
    if [ "X${RES}" = "X${1}" ]
    then
	RET=0
    fi
    return ${RET}
}

MAX_STARTS=3	# Max number of quick daemon deaths before give up
case `uname -s` in
SunOS)
    PATH=/usr/xpg4/bin:$PATH
    ;;
esac
if [ -f ${LOCKSS_HOME}/etc/lockss/functions ] ; then
    if is_secure ${LOCKSS_HOME}/etc/lockss/functions ; then
        . ${LOCKSS_HOME}/etc/lockss/functions
    else
        echo "${LOCKSS_HOME}/etc/lockss/functions insecure"
        exit 1
    fi
else
    echo "Can't find LOCKSS functions"
    exit 1
fi
if [ "X$1" = X ]; then
    echo "Usage: startdaemon user"
    exit 1
fi
set_variables $1
if [ -f ${CFG_FILE} ]; then
    # CFG_FILE should only set environment variables - avoid executing it
    for KEY in `sed -n 's/^\([A-Z0-9_]*\)=.*$/\1/p' <${CFG_FILE}` ; do
        VALUE=`sed -n -e '/\`/d' -e /${KEY}=/s///p <${CFG_FILE}`
        VALUE2=`echo ${VALUE} | sed -n '/^"\(.*\)"$/s//\1/p'`
        if [ "X${VALUE2}" = X ]; then
            # Not quoted
            export ${KEY}=${VALUE}
        else
            # ${VALUE} quoted
            export ${KEY}="\"${VALUE2}\""
        fi
    done
#    set_variables_from ${CFG_FILE}
else
    echo "${CFG_FILE} missing; run ${CFG_SCRIPT}"
    exit 1
fi
if [ "X${LOCKSS_CONFIG_VERSION}" != X ] ; then
    CURRENT_CONFIG_VERSION=`sed -n 's/^.*LOCKSS_CONFIG_VERSION=\([1-9][0-9]*\).*$/\1/p' <${LOCKSS_HOME}/etc/lockss/hostconfig`
    if [ "X${CURRENT_CONFIG_VERSION}" != X -a "${LOCKSS_CONFIG_VERSION}" != "${CURRENT_CONFIG_VERSION}" ] ; then
        echo "Config version skew: required ${CURRENT_CONFIG_VERSION} have ${LOCKSS_CONFIG_VERSION}."
        echo "Not starting LOCKSS. Please run ${LOCKSS_HOME}/etc/lockss/hostconfig."
        exit 1
    fi
fi
if [ "X${LOG_FILE}" = X -o ! -f ${LOG_FILE} ]; then
    echo "No log file - can't start $1"
    exit 1
fi
if [ -f /etc/cron.daily/mlocate.cron ]; then
    # XXX for 1.48, disable updatedb
    ed /etc/cron.daily/mlocate.cron >/dev/null 2>&1 <<Funky-EOF
g/^\([^#]\)/s//#\1/
w
q
Funky-EOF
fi
touch ${KEEP_GOING}
chown $1 ${KEEP_GOING}
if [ -x ${LOCKSS_HOME}/etc/lockss/runssl.$1 ]; then
    RUN_SSL="${LOCKSS_HOME}/etc/lockss/runssl.$1"
elif [ -x ${LOCKSS_HOME}/etc/lockss/runssl ]; then
    RUN_SSL="${LOCKSS_HOME}/etc/lockss/runssl"
fi
START_FLAG=`mktemp /tmp/lockss.start.XXXXX`
START_COUNT=1
while [ -f ${KEEP_GOING} ]; do
    # If optional SSL setup script exists and is executable, run it.
    # It will have the environment variables set by set_variables()
    # in ${LOCKSS_HOME}/etc/lockss/functions and by ${CFG_FILE}
    if [ "X${RUN_SSL}" != X ]; then
        if [ -x ${RUN_SSL} ]; then
            LOCKSS_CONFIG_DIR=${RUN_DIR}
            mkdir -p ${LOCKSS_CONFIG_DIR}
            chown root ${LOCKSS_CONFIG_DIR}
            chmod go-w ${LOCKSS_CONFIG_DIR}
            rm -f ${LOCKSS_SSL_CONFIG}
            ${RUN_SSL} --release 1.49.0 --user $1 >>${LOG_FILE} 2>&1
            if [ -s ${LOCKSS_SSL_CONFIG} ]; then
                chmod go-rwx ${LOCKSS_SSL_CONFIG}
                chown $1 ${LOCKSS_SSL_CONFIG}
            fi
        fi
    fi
    FLAG_FILE=`mktemp /tmp/lockss.flag.XXXXX`
    chown $1 ${FLAG_FILE}
    export FLAG_FILE
    sleep 60 && rm -f ${FLAG_FILE} &
    COMMAND="ulimit -S -c 0 >/dev/null 2>&1 ; ${LOCKSS_HOME}/etc/lockss/rundaemon wait ${FLAG_FILE}"
    case `uname -s` in
    Linux)
        runuser -s /bin/bash - $1 -c "${COMMAND}"
        ;;
    SunOS)
        export USER=$1
        cd /tmp
        su $1 -c "${COMMAND}"
        ;;
    esac
    EXIT_CODE=$?
    echo "stopped with status ${EXIT_CODE} at `date`." >>${LOG_FILE}
    if [ -e ${FLAG_FILE} ]; then
        echo "${FLAG_FILE} exists - removing and exiting." >>${LOG_FILE}
	rm -f ${FLAG_FILE}
        exit 1
    fi
    START_COUNT=`expr ${START_COUNT} + 1`
    if [ ${START_COUNT} -gt ${MAX_STARTS} ]; then
        if [ X`find ${START_FLAG} -mmin ${MAX_STARTS}` = X ]; then
            # Daemon has been exiting once per minute - give up
            echo "Daemon exiting rapidly" >>${LOG_FILE}
            break
        fi
        START_COUNT=1
        touch ${START_FLAG}
    fi
    if [ -f ${KEEP_GOING} ]; then
        sleep 30
    fi
done &
exit 0
