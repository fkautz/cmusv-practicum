#!/bin/bash

. /etc/lockss/functions

if [ "X$1" = Xwait ]; then
    WAIT=Y
fi
set_lockss_user ${USER}
set_variables ${USER}
DAEMON_COUNT=0
for A in ${LOCKSS_USER}
do
	DAEMON_COUNT=`expr ${DAEMON_COUNT} + 1`
done
NUMERATOR=2
if [ "${DAEMON_COUNT}X" = 2X ]
then
	NUMERATOR=1
fi
# set LOCKSS_JAVA_HEAP to override using 2/3  memory for
# all daemons combined
#LOCKSS_JAVA_HEAP=500m
OS_TYPE=`uname -s`
case ${OS_TYPE} in
Linux)          
	# look in /proc/meminfo for "MemTotal:      1002108 kB"
	if [ "${LOCKSS_JAVA_HEAP}X" = X -a -f /proc/meminfo ]
	then
		MEM_IN_KB=`sed -n -e 's/MemTotal:[ 	]*\([0-9]*\) kB/\1/p' </proc/meminfo`
		MEM_IN_KB=`expr \( ${MEM_IN_KB} '*' ${NUMERATOR} \) / 3`
		LOCKSS_JAVA_HEAP=${MEM_IN_KB}k
	fi
        ;;
esac

if [ -f ${LOCKSS_HOME}/etc/lockss/config.$USER.dat ]
then
	CFG_FILE=${LOCKSS_HOME}/etc/lockss/config.$USER.dat
fi

if [ -f ${CFG_FILE} ]; then
  . ${CFG_FILE}
else
  echo "${CFG_FILE} missing; run ${CFG_SCRIPT}"
  exit 1
fi

CLASSPATH=@CLASSPATH@
DAEMON_CLASS=org.lockss.app.LockssDaemon
if [ "X${LOCKSS_JAVA_SWITCHES}" = "X" ]; then
    LOCKSS_JAVA_SWITCHES="-server -Xmx${LOCKSS_JAVA_HEAP:-500m} -Dsun.net.inetaddr.ttl=3600 -showversion"
fi

# if LOCKSS_PROPS_URL starts with "-" it is assumed to be the of the form
#    -p <url1> [-p <url2> ...]
if [ "X${LOCKSS_PROPS_URL}" = "X-*" ]; then
    DAEMON_ARGS="-p ${LOCKSS_PROPS_URL} -p ${LOCAL_TXT}"
else
    DAEMON_ARGS="-p ${LOCKSS_PROPS_URL} -p ${LOCAL_TXT}"
fi
if [ "X${LOCKSS_TEST_GROUP}" != "X" ]; then
    DAEMON_ARGS="-g ${LOCKSS_TEST_GROUP} ${DAEMON_ARGS}"
else
    DAEMON_ARGS="-g prod ${DAEMON_ARGS}"
fi

LOCKSS_V3_IDENTITY="TCP:[${LOCKSS_IPADDR}]:${LOCKSS_V3_PORT}"

#LOCKSS_JAVA_SWITCHES="${LOCKSS_JAVA_SWITCHES} -Dorg.lockss.defaultLogLevel=DEBUG3"

cat >${LOCAL_TXT} <<EOF
org.lockss.platform.localIPAddress=${LOCKSS_IPADDR}
org.lockss.platform.v3.identity=${LOCKSS_V3_IDENTITY}
org.lockss.platform.diskSpacePaths=${LOCKSS_DISK_PATHS}
org.lockss.platform.version=@PLATFORM_VERSION@
org.lockss.platform.sysadminemail=${LOCKSS_EMAIL}
org.lockss.platform.accesssubnet=${LOCKSS_ACCESS_SUBNET}
org.lockss.platform.smtphost=${LOCKSS_MAILHUB}
org.lockss.platform.smtpport=25
org.lockss.platform.logdirectory=${LOCKSS_HOME}/var/log/lockss
org.lockss.platform.logfile=daemon
org.lockss.log.targets=org.lockss.util.FileTarget
org.lockss.platform.fqdn=${LOCKSS_HOSTNAME}
org.lockss.platform.ui.username=${LOCKSS_ADMIN_USER}
org.lockss.platform.ui.password=${LOCKSS_ADMIN_PASSWD}
org.lockss.proxy.port=${LOCKSS_PROXY_PORT}
org.lockss.ui.port=${LOCKSS_UI_PORT}
EOF
cd ${LOCKSS_HOME}
echo "Starting daemon at `date`" >> ${LOG_FILE}
${LOCKSS_JAVA_CMD} ${LOCKSS_JAVA_SWITCHES} -classpath ${CLASSPATH} ${DAEMON_CLASS} ${DAEMON_ARGS} >> "$LOG_FILE" 2>&1 &
echo $! >${PID_FILE}
if [ X${WAIT} != X ]; then
    wait `cat ${PID_FILE}`
fi


