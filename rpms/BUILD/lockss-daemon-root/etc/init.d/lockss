#!/bin/sh

. /etc/init.d/functions
. /etc/profile

LOCKSS_USER=lockss
LOG_DIR="/var/log/lockss"
LOG_FILE="${LOG_DIR}/stdout"
PID_FILE="/var/run/lockss.pid"
CFG_FILE=/etc/lockss/hostconfig
KEEP_GOING=~lockss/KeepGoing

TIMESTAMP=`date`

case "$1" in
    start)
	if [ ! -r ${CFG_FILE} ]; then
	    echo "Can't start LOCKSS: ${CFG_FILE} missing or not readable"
	    exit 1
	fi
	if [ ! -d ${LOG_DIR} ]; then
	    mkdir -p ${LOG_DIR}
	    chown ${LOCKSS_USER} ${LOG_DIR}
	    chmod 755 ${LOG_DIR}
	fi
	if [ ! -f ${PID_FILE} ]; then
	    touch ${PID_FILE}
	fi
	chown ${LOCKSS_USER} ${PID_FILE}
	chmod 644 ${PID_FILE}
	echo "Starting LOCKSS"
	echo "Starting LOCKSS at $TIMESTAMP" >> ${LOG_FILE}
	chown ${LOCKSS_USER} ${LOG_FILE}
	daemon --user ${LOCKSS_USER} --check lockss /etc/lockss/runforever
#	daemon --user ${LOCKSS_USER} --check lockss /etc/lockss/rundaemon
	echo "."
	;;
    stop)
	echo "Stopping LOCKSS"
	rm -f "${KEEP_GOING}"
	killproc lockss
	echo "."
	;;
    *)
	echo "Usage: $0 {start|stop}"
	exit 1
	;;
esac

exit 0
