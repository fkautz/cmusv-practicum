#!/bin/sh

. /etc/init.d/functions
. /etc/profile

OS_TYPE=`uname -s`
case ${OS_TYPE} in
SunOS)
	LOCKSS_USER=lockss
	CONFIG_USER=`/usr/ucb/whoami`
	LOCKSS_HOME=~lockss
	LOG_DIR="${LOCKSS_HOME}/var/log/lockss"
	LOG_FILE="${LOG_DIR}/stdout"
	PID_FILE="${LOCKSS_HOME}/var/run/lockss.pid"
	CFG_FILE=${LOCKSS_HOME}/etc/lockss/hostconfig
	KEEP_GOING=~lockss/KeepGoing
	;;
Linux)
	LOCKSS_USER=lockss
	CONFIG_USER=`whoami`
	LOG_DIR="/var/log/lockss"
	LOG_FILE="${LOG_DIR}/stdout"
	PID_FILE="/var/run/lockss.pid"
	CFG_FILE=/etc/lockss/hostconfig
	KEEP_GOING=~lockss/KeepGoing
	;;
esac

TIMESTAMP=`date`

case "$1" in
    start)
	if [ ! -r ${CFG_FILE} ]; then
	    echo "Can't start LOCKSS: ${CFG_FILE} missing or not readable"
	    exit 1
	fi
	if [ ! -d ${LOG_DIR} ]; then
	    mkdir -p ${LOG_DIR}
	    if [ "X${CONFIG_USER}" != "X${LOCKSS_USER}" ] ; then
		chown ${LOCKSS_USER} ${LOG_DIR}
		chmod 755 ${LOG_DIR}
	    fi
	fi
	if [ ! -f ${PID_FILE} ]; then
	    touch ${PID_FILE}
	fi
	if [ "X${CONFIG_USER}" != "X${LOCKSS_USER}" ] ; then
	    chown ${LOCKSS_USER} ${PID_FILE}
	    chmod 644 ${PID_FILE}
	fi
	echo "Starting LOCKSS"
	echo "Starting LOCKSS at $TIMESTAMP" >> ${LOG_FILE}
	if [ "X${CONFIG_USER}" != "X${LOCKSS_USER}" ] ; then
	    chown ${LOCKSS_USER} ${LOG_FILE}
	    daemon --user ${LOCKSS_USER} --check lockss /etc/lockss/runforever
	else
	    sh /etc/lockss/rundaemon
	fi
	echo "."
	;;
    stop)
	echo "Stopping LOCKSS"
	rm -f "${KEEP_GOING}"
	killproc lockss
	echo "."
	;;
    *)
	echo "Usage: $0 {start|stop}"
	exit 1
	;;
esac

exit 0
